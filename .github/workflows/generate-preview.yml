name: Generate Preview PDF

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'Titre du bundle (optionnel, par défaut: repo name)'
        required: false
        default: ''
      version:
        description: 'Version du bundle (optionnel, par défaut: tag ou release)'
        required: false
        default: ''
  release:
    types: [published]  # déclenche lors d’une release publiée

jobs:
  generate-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set title and version
        id: vars
        run: |
          INPUT_TITLE="${{ github.event.inputs.title }}"
          INPUT_VERSION="${{ github.event.inputs.version }}"

          # Nom du repo
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          TITLE="$INPUT_TITLE"
          VERSION="$INPUT_VERSION"

          # Fallback si inputs vides
          if [ -z "$TITLE" ]; then
            TITLE="${REPO_NAME//-/ }"
          fi

          # Version automatique selon le type de déclencheur
          if [ -z "$VERSION" ]; then
            if [ "${GITHUB_EVENT_NAME}" = "release" ]; then
              VERSION="${GITHUB_REF_NAME}"  # tag de la release
            elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
              VERSION="${GITHUB_REF##*/}"
            else
              VERSION="dev"
            fi
          fi

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc wkhtmltopdf fonts-dejavu librsvg2-bin

      - name: Prepare QuickLook folder
        run: mkdir -p MyBundle/QuickLook

      - name: Generate preview markdown
        run: |
          cat <<EOF > preview.md
---
title: "${{ steps.vars.outputs.title }}"
---

<img src="Contents/Resources/logo.svg" width="200" />

# ${{ steps.vars.outputs.title }}

**Version :** ${{ steps.vars.outputs.version }}

---

Généré automatiquement depuis GitHub Actions.
EOF

      - name: Generate Preview.pdf
        run: |
          pandoc preview.md \
            --pdf-engine=wkhtmltopdf \
            -o MyBundle/QuickLook/Preview.pdf

      - name: Upload Preview.pdf artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-pdf
          path: MyBundle/QuickLook/Preview.pdf
